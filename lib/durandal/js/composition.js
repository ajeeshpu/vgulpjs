/**
 * Durandal 2.0.1 Copyright (c) 2012 Blue Spire Consulting, Inc. All Rights Reserved.
 * Available via the MIT license.
 * see: http://durandaljs.com or https://github.com/BlueSpire/Durandal for details.
 */

define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,t,n,r,i,s,o){function g(e){var t=[],n={childElements:t,activeView:null},r=o.virtualElements.firstChild(e);while(r)r.nodeType==1&&(t.push(r),r.getAttribute(a)&&(n.activeView=r)),r=o.virtualElements.nextSibling(r);return n.activeView||(n.activeView=t[0]),n}function y(){c--,c===0&&setTimeout(function(){var t=l.length;while(t--)try{l[t]()}catch(n){e.error(n)}l=[]},1)}function b(e){delete e.activeView,delete e.viewElements}function w(t,n,r){if(r)n();else if(t.activate&&t.model&&t.model.activate){var i;try{e.isArray(t.activationData)?i=t.model.activate.apply(t.model,t.activationData):i=t.model.activate(t.activationData),i&&i.then?i.then(n,function(t){e.error(t),n()}):i||i===undefined?n():(y(),b(t))}catch(s){e.error(s)}}else n()}function E(){var t=this;t.activeView&&t.activeView.removeAttribute(a);if(t.child)try{t.model&&t.model.attached&&(t.composingNewView||
t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t),t.attached&&t.attached(t.child,t.parent,t),t.child.setAttribute(a,!0),t.composingNewView&&t.model&&t.model.detached&&o.utils.domNodeDisposal.addDisposeCallback(t.child,function(){try{t.model.detached(t.child,t.parent,t)}catch(n){e.error(n)}})}catch(n){e.error(n)}t.triggerAttach=e.noop}function S(t){if(e.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var n=t.activeView.getAttribute("data-view"),r=t.child.getAttribute("data-view");return n!=r}}return!0}return!1}function x(e){for(var t=0,n=e.length,r=[];t<n;t++){var i=e[t].cloneNode(!0);r.push(i)}return r}function T(e){var t=x(e.parts),n=f.getParts(t,null,!0),r=f.getParts(e.child);for(var i in n)s(r[i]).replaceWith(n[i])}function N(t){var n=o.virtualElements.childNodes(t.parent),r,i;if(!e.isArray(n)){var s=[];for(r=0,i=n.length;r<i;r++)s[r]=n[r];n=s}for(r=1,i=n.length;r<i;r++)o.removeNode(n[r])}function C
(e){o.utils.domData.set(e,v,e.style.display),e.style.display="none"}function k(e){e.style.display=o.utils.domData.get(e,v)}function L(e){var t=e.getAttribute("data-bind");if(!t)return!1;for(var n=0,r=m.length;n<r;n++)if(t.indexOf(m[n])>-1)return!0;return!1}var u={},a="data-active-view",f,l=[],c=0,h="durandal-composition-data",p="data-part",d=["model","view","transition","area","strategy","activationData"],v="durandal-visibility-data",m=["compose:"],A={complete:function(e){l.push(e)}};return f={composeBindings:m,convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:A,addBindingHandler:function(e,t,n){var r,i="composition-handler-"+e,s;t=t||o.bindingHandlers[e],n=n||function(){return undefined},s=o.bindingHandlers[e]={init:function(e,r,s,u,a){if(c>0){var l={trigger:o.observable(null)};f.current.complete(function(){t.init&&t.init(e,r,s,u,a),t.update&&(o.utils.domData.set(e,i,t),l.trigger("trigger"))}),o.utils.domData.set(e,i,l)}else o.utils.domData
.set(e,i,t),t.init&&t.init(e,r,s,u,a);return n(e,r,s,u,a)},update:function(e,t,n,r,s){var u=o.utils.domData.get(e,i);if(u.update)return u.update(e,t,n,r,s);u.trigger&&u.trigger()}};for(r in t)r!=="init"&&r!=="update"&&(s[r]=t[r])},getParts:function(e,t,n){t=t||{};if(!e)return t;e.length===undefined&&(e=[e]);for(var r=0,i=e.length;r<i;r++){var s=e[r];if(s.getAttribute){if(!n&&L(s))continue;var o=s.getAttribute(p);o&&(t[o]=s),!n&&s.hasChildNodes()&&f.getParts(s.childNodes,t)}}return t},cloneNodes:x,finalize:function(t){t.transition===undefined&&(t.transition=this.defaultTransitionName);if(!t.child&&!t.activeView)t.cacheViews||o.virtualElements.emptyNode(t.parent),t.triggerAttach(),y(),b(t);else if(S(t)){var r=this.convertTransitionToModuleId(t.transition);e.acquire(r).then(function(e){t.transition=e,e(t).then(function(){if(!t.cacheViews)t.child?N(t):o.virtualElements.emptyNode(t.parent);else if(t.activeView){var e=n.getBindingInstruction(t.activeView);e&&e.cacheViews!=undefined&&!e.cacheViews&&
o.removeNode(t.activeView)}t.triggerAttach(),y(),b(t)})}).fail(function(t){e.error("Failed to load transition ("+r+"). Details: "+t.message)})}else{if(t.child!=t.activeView){if(t.cacheViews&&t.activeView){var i=n.getBindingInstruction(t.activeView);!i||i.cacheViews!=undefined&&!i.cacheViews?o.removeNode(t.activeView):C(t.activeView)}t.child?(t.cacheViews||N(t),k(t.child)):t.cacheViews||o.virtualElements.emptyNode(t.parent)}t.triggerAttach(),y(),b(t)}},bindAndShow:function(e,t,i){t.child=e,t.cacheViews?t.composingNewView=o.utils.arrayIndexOf(t.viewElements,e)==-1:t.composingNewView=!0,w(t,function(){t.binding&&t.binding(t.child,t.parent,t);if(t.preserveContext&&t.bindingContext)t.composingNewView&&(t.parts&&T(t),C(e),o.virtualElements.prepend(t.parent,e),n.bindContext(t.bindingContext,e,t.model));else if(e){var i=t.model||u,s=o.dataFor(e);if(s!=i){if(!t.composingNewView){o.removeNode(e),r.createView(e.getAttribute("data-view")).then(function(e){f.bindAndShow(e,t,!0)});return}t.parts&&T(t
),C(e),o.virtualElements.prepend(t.parent,e),n.bind(i,e)}}f.finalize(t)},i)},defaultStrategy:function(e){return t.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(t,n){var s=t(),u=o.utils.unwrapObservable(s)||{},a=i.isActivator(s),f;if(e.isString(u))return r.isViewUrl(u)?u={view:u}:u={model:u,activate:!0},u;f=e.getModuleId(u);if(f)return u={model:u,activate:!0},u;!a&&u.model&&(a=i.isActivator(u.model));for(var l in u)o.utils.arrayIndexOf(d,l)!=-1?u[l]=o.utils.unwrapObservable(u[l]):u[l]=u[l];return a?u.activate=!1:u.activate===undefined&&(u.activate=!0),u},executeStrategy:function(e){e.strategy(e).then(function(t){f.bindAndShow(t,e)})},inject:function(n){if(!n.model){this.bindAndShow(null,n);return}if(n.view){t.locateView(n.view,n.area,n.viewElements).then(function(e){f.bindAndShow(e,n)});return}n.strategy||(n.strategy=this.defaultStrategy),e.isString(n.strategy)?e.acquire(n.strategy).then(function(e){n.strategy=e,f.executeStrategy(n)}).fail(function(t){e.error("Failed to load view strategy ("+
n.strategy+"). Details: "+t.message)}):this.executeStrategy(n)},compose:function(n,r,i,s){c++,s||(r=f.getSettings(function(){return r},n)),r.compositionComplete&&l.push(function(){r.compositionComplete(r.child,r.parent,r)}),l.push(function(){r.composingNewView&&r.model&&r.model.compositionComplete&&r.model.compositionComplete(r.child,r.parent,r)});var o=g(n);r.activeView=o.activeView,r.parent=n,r.triggerAttach=E,r.bindingContext=i,r.cacheViews&&!r.viewElements&&(r.viewElements=o.childElements),r.model?e.isString(r.model)?e.acquire(r.model).then(function(t){r.model=e.resolveObject(t),f.inject(r)}).fail(function(t){e.error("Failed to load composed module ("+r.model+"). Details: "+t.message)}):f.inject(r):r.view?(r.area=r.area||"partial",r.preserveContext=!0,t.locateView(r.view,r.area,r.viewElements).then(function(e){f.bindAndShow(e,r)})):this.bindAndShow(null,r)}},o.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,i,s){var u=f.getSettings
(t,e);if(u.mode){var a=o.utils.domData.get(e,h);if(!a){var l=o.virtualElements.childNodes(e);a={},u.mode==="inline"?a.view=r.ensureSingleElement(l):u.mode==="templated"&&(a.parts=x(l)),o.virtualElements.emptyNode(e),o.utils.domData.set(e,h,a)}u.mode==="inline"?u.view=a.view.cloneNode(!0):u.mode==="templated"&&(u.parts=a.parts),u.preserveContext=!0}f.compose(e,u,s,!0)}},o.virtualElements.allowedBindings.compose=!0,f});