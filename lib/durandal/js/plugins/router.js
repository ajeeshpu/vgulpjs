/**
 * Durandal 2.0.1 Copyright (c) 2012 Blue Spire Consulting, Inc. All Rights Reserved.
 * Available via the MIT license.
 * see: http://durandaljs.com or https://github.com/BlueSpire/Durandal for details.
 */

define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(e,t,n,r,i,s,o,u){function v(e){return e=e.replace(c,"\\$&").replace(a,"(?:$1)?").replace(f,function(e,t){return t?e:"([^/]+)"}).replace(l,"(.*?)"),new RegExp("^"+e+"$")}function m(e){var t=e.indexOf(":"),n=t>0?t-1:e.length;return e.substring(0,n)}function g(e,t){return e.indexOf(t,e.length-t.length)!==-1}function y(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var n=0,r=e.length;n<r;n++)if(e[n]!=t[n])return!1;return!0}var a=/\((.*?)\)/g,f=/(\(\?)?:\w+/g,l=/\*\w+/g,c=/[\-{}\[\]+?.,\\\^$|#\s]/g,h,p,d=/\/$/,b=function(){function w(e){return e.router&&e.router.parent==c}function E(e){f&&f.config.isActive&&f.config.isActive(e)}function S(t,n){e.log("Navigation Complete",t,n);var r=e.getModuleId(a);r&&c.trigger("router:navigation:from:"+r),a=t,E(!1),f=n,E(!0);var i=e.getModuleId(a);i&&c.trigger("router:navigation:to:"+i),w(t)||c.updateDocumentTitle
(t,n),p.explicitNavigation=!1,p.navigatingBack=!1,c.trigger("router:navigation:complete",t,n,c)}function x(t,n){e.log("Navigation Cancelled"),c.activeInstruction(f),f&&c.navigate(f.fragment,!1),u(!1),p.explicitNavigation=!1,p.navigatingBack=!1,c.trigger("router:navigation:cancelled",t,n,c)}function T(t){e.log("Navigation Redirecting"),u(!1),p.explicitNavigation=!1,p.navigatingBack=!1,c.navigate(t,{trigger:!0,replace:!0})}function N(t,n,r){p.navigatingBack=!p.explicitNavigation&&a!=r.fragment,c.trigger("router:route:activating",n,r,c),t.activateItem(n,r.params).then(function(e){if(e){var i=a;S(n,r);if(w(n)){var s=r.fragment;r.queryString&&(s+="?"+r.queryString),n.router.loadUrl(s)}i==n&&(c.attached(),c.compositionComplete())}else t.settings.lifecycleData&&t.settings.lifecycleData.redirect?T(t.settings.lifecycleData.redirect):x(n,r);h&&(h.resolve(),h=null)}).fail(function(t){e.error(t)})}function C(t,n,r){var i=c.guardRoute(n,r);i?i.then?i.then(function(i){i?e.isString(i)?T(i):N(t,n,r):x(
n,r)}):e.isString(i)?T(i):N(t,n,r):x(n,r)}function k(e,t,n){c.guardRoute?C(e,t,n):N(e,t,n)}function L(e){return f&&f.config.moduleId==e.config.moduleId&&a&&(a.canReuseForRoute&&a.canReuseForRoute.apply(a,e.params)||!a.canReuseForRoute&&a.router&&a.router.loadUrl)}function A(){if(u())return;var t=i.shift();i=[];if(!t)return;u(!0),c.activeInstruction(t),L(t)?k(n.create(),a,t):e.acquire(t.config.moduleId).then(function(n){var r=e.resolveObject(n);k(l,r,t)}).fail(function(n){e.error("Failed to load routed module ("+t.config.moduleId+"). Details: "+n.message)})}function O(e){i.unshift(e),A()}function M(e,t,n){var r=e.exec(t).slice(1);for(var i=0;i<r.length;i++){var s=r[i];r[i]=s?decodeURIComponent(s):null}var o=c.parseQueryString(n);return o&&r.push(o),{params:r,queryParams:o}}function _(t){c.trigger("router:route:before-config",t,c),e.isRegExp(t)?t.routePattern=t.route:(t.title=t.title||c.convertRouteToTitle(t.route),t.moduleId=t.moduleId||c.convertRouteToModuleId(t.route),t.hash=t.hash||c.
convertRouteToHash(t.route),t.routePattern=v(t.route)),t.isActive=t.isActive||o.observable(!1),c.trigger("router:route:after-config",t,c),c.routes.push(t),c.route(t.routePattern,function(e,n){var r=M(t.routePattern,e,n);O({fragment:e,queryString:n,config:t,params:r.params,queryParams:r.queryParams})})}function D(t){if(e.isArray(t.route)){var n=t.isActive||o.observable(!1);for(var r=0,i=t.route.length;r<i;r++){var s=e.extend({},t);s.route=t.route[r],s.isActive=n,r>0&&delete s.nav,_(s)}}else _(t);return c}var i=[],u=o.observable(!1),a,f,l=n.create(),c={handlers:[],routes:[],navigationModel:o.observableArray([]),activeItem:l,isNavigating:o.computed(function(){var e=l(),t=u(),n=e&&e.router&&e.router!=c&&e.router.isNavigating()?!0:!1;return t||n}),activeInstruction:o.observable(null),__router__:!0};return r.includeIn(c),l.settings.areSameItem=function(e,t,n,r){return e==t?y(n,r):!1},c.parseQueryString=function(e){var t,n;if(!e)return null;n=e.split("&");if(n.length==0)return null;t={};for(var r=0
;r<n.length;r++){var i=n[r];if(i==="")continue;var s=i.split("=");t[s[0]]=s[1]&&decodeURIComponent(s[1].replace(/\+/g," "))}return t},c.route=function(e,t){c.handlers.push({routePattern:e,callback:t})},c.loadUrl=function(t){var n=c.handlers,r=null,i=t,o=t.indexOf("?");o!=-1&&(i=t.substring(0,o),r=t.substr(o+1));if(c.relativeToParentRouter){var u=this.parent.activeInstruction();i=u.params.join("/"),i&&i.charAt(0)=="/"&&(i=i.substr(1)),i||(i=""),i=i.replace("//","/").replace("//","/")}i=i.replace(d,"");for(var a=0;a<n.length;a++){var l=n[a];if(l.routePattern.test(i))return l.callback(i,r),!0}return e.log("Route Not Found"),c.trigger("router:route:not-found",t,c),f&&s.navigate(f.fragment,{trigger:!1,replace:!0}),p.explicitNavigation=!1,p.navigatingBack=!1,!1},c.updateDocumentTitle=function(e,n){n.config.title?t.title?document.title=n.config.title+" | "+t.title:document.title=n.config.title:t.title&&(document.title=t.title)},c.navigate=function(e,t){return e&&e.indexOf("://")!=-1?(window.location
.href=e,!0):(p.explicitNavigation=!0,s.navigate(e,t))},c.navigateBack=function(){s.navigateBack()},c.attached=function(){c.trigger("router:navigation:attached",a,f,c)},c.compositionComplete=function(){u(!1),c.trigger("router:navigation:composition-complete",a,f,c),A()},c.convertRouteToHash=function(e){if(c.relativeToParentRouter){var t=c.parent.activeInstruction(),n=t.config.hash+"/"+e;return s._hasPushState&&(n="/"+n),n=n.replace("//","/").replace("//","/"),n}return s._hasPushState?e:"#"+e},c.convertRouteToModuleId=function(e){return m(e)},c.convertRouteToTitle=function(e){var t=m(e);return t.substring(0,1).toUpperCase()+t.substring(1)},c.map=function(t,n){if(e.isArray(t)){for(var r=0;r<t.length;r++)c.map(t[r]);return c}return e.isString(t)||e.isRegExp(t)?(n?e.isString(n)&&(n={moduleId:n}):n={},n.route=t):n=t,D(n)},c.buildNavigationModel=function(t){var n=[],r=c.routes,i=t||100;for(var s=0;s<r.length;s++){var o=r[s];o.nav&&(e.isNumber(o.nav)||(o.nav=++i),n.push(o))}return n.sort(function(
e,t){return e.nav-t.nav}),c.navigationModel(n),c},c.mapUnknownRoutes=function(t,n){var r="*catchall",i=v(r);return c.route(i,function(o,u){var a=M(i,o,u),f={fragment:o,queryString:u,config:{route:r,routePattern:i},params:a.params,queryParams:a.queryParams};if(!t)f.config.moduleId=o;else if(e.isString(t))f.config.moduleId=t,n&&s.navigate(n,{trigger:!1,replace:!0});else if(e.isFunction(t)){var l=t(f);if(l&&l.then){l.then(function(){c.trigger("router:route:before-config",f.config,c),c.trigger("router:route:after-config",f.config,c),O(f)});return}}else f.config=t,f.config.route=r,f.config.routePattern=i;c.trigger("router:route:before-config",f.config,c),c.trigger("router:route:after-config",f.config,c),O(f)}),c},c.reset=function(){return f=a=undefined,c.handlers=[],c.routes=[],c.off(),delete c.options,c},c.makeRelative=function(t){return e.isString(t)&&(t={moduleId:t,route:t}),t.moduleId&&!g(t.moduleId,"/")&&(t.moduleId+="/"),t.route&&!g(t.route,"/")&&(t.route+="/"),t.fromParent&&(c.relativeToParentRouter=!0
),c.on("router:route:before-config").then(function(e){t.moduleId&&(e.moduleId=t.moduleId+e.moduleId),t.route&&(e.route===""?e.route=t.route.substring(0,t.route.length-1):e.route=t.route+e.route)}),c},c.createChildRouter=function(){var e=b();return e.parent=c,e},c};return p=b(),p.explicitNavigation=!1,p.navigatingBack=!1,p.targetIsThisWindow=function(e){var t=u(e.target).attr("target");return!t||t===window.name||t==="_self"||t==="top"&&window===window.top?!0:!1},p.activate=function(t){return e.defer(function(n){h=n,p.options=e.extend({routeHandler:p.loadUrl},p.options,t),s.activate(p.options);if(s._hasPushState){var r=p.routes,i=r.length;while(i--){var o=r[i];o.hash=o.hash.replace("#","")}}u(document).delegate("a","click",function(e){if(s._hasPushState){if(!e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&p.targetIsThisWindow(e)){var t=u(this).attr("href");t!=null&&t.charAt(0)!=="#"&&!/^[a-z]+:/i.test(t)&&(p.explicitNavigation=!0,e.preventDefault(),s.navigate(t))}}else p.explicitNavigation=!0
}),s.options.silent&&h&&(h.resolve(),h=null)}).promise()},p.deactivate=function(){s.deactivate()},p.install=function(){o.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,r,s){var u=o.utils.unwrapObservable(t())||{};if(u.__router__)u={model:u.activeItem(),attached:u.attached,compositionComplete:u.compositionComplete,activate:!1};else{var a=o.utils.unwrapObservable(u.router||r.router)||p;u.model=a.activeItem(),u.attached=a.attached,u.compositionComplete=a.compositionComplete,u.activate=!1}i.compose(e,u,s)}},o.virtualElements.allowedBindings.router=!0},p});